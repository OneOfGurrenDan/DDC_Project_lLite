# Разработка главной страницы - Навигация по реализации

## Содержание

1. [Цель сайта и функциональные возможности](#1-цель-сайта-и-функциональные-возможности)
2. [Виджеты главной страницы](#2-виджеты-главной-страницы)
3. [Наполнение базы данных](#3-наполнение-базы-данных)
4. [Данные из 3+ таблиц](#4-данные-из-3-таблиц)
5. [Примеры QuerySet](#5-примеры-queryset)
6. [Агрегатные функции](#6-агрегатные-функции)
7. [Поиск данных](#7-поиск-данных)
8. [Авторизация](#8-авторизация)
9. [User-friendly дизайн](#9-user-friendly-дизайн)
10. [DEBUG=False режим](#10-debugfalse-режим)

---

## 1. Цель сайта и функциональные возможности

### Цель сайта
**DDC Biotech Интранет** - внутренняя система управления лабораторией для:
- Учета реагентов и расходных материалов
- Управления задачами сотрудников
- Контроля клеточных культур
- Документооборота и объявлений

### 3 виджета главной страницы (dashboard)

**View функция:**
```35:152:intranet/views.py
@login_required
@cache_page(60 * 5)  # Кеш на 5 минут
def dashboard(request):
    """
    Главная страница с виджетами и поиском
    
    Демонстрирует:
    - Виджеты с данными из 3+ таблиц
    - aggregate(), Count(), F()
    - Поиск с __icontains, __contains, values(), values_list(), count(), exists()
    - Пагинацию с try/except
    """
```

#### Виджет 1: Последние объявления
```81:84:intranet/views.py
# ВИДЖЕТ 1: Последние объявления
latest_announcements = Announcement.objects.select_related('author').order_by(
    '-is_pinned', '-published_at'
)[:5]
```
- **Ограничение:** 5 записей
- **Сортировка:** Закрепленные сначала, затем по дате (новые первыми)

#### Виджет 2: Актуальные задачи
```86:91:intranet/views.py
# ВИДЖЕТ 2: Актуальные задачи текущего пользователя
user_tasks = Task.objects.filter(
    assignee=request.user
).exclude(
    status='done'
).select_related('creator').order_by('deadline', '-priority')[:5]
```
- **Ограничение:** 5 задач
- **Логика:** Только задачи текущего пользователя, исключая выполненные
- **Сортировка:** По дедлайну (ближайшие первыми), затем по приоритету

#### Виджет 3: Критические реагенты
```99:103:intranet/views.py
# ВИДЖЕТ 3: Критические реагенты
# Реагенты с остатком ниже минимального порога
critical_reagents = Reagent.objects.filter(
    on_hand__lt=F('min_threshold')
).order_by('on_hand')[:5]
```
- **Ограничение:** 5 реагентов
- **Логика:** Остаток ниже минимального порога (F-выражение)
- **Сортировка:** От меньшего остатка к большему

**URL маршрут:**
```12:12:intranet/urls.py
path('', views.dashboard, name='dashboard'),
```

---

## 2. Виджеты главной страницы

### Виджет с просроченными задачами
```93:97:intranet/views.py
# Подсчет просроченных задач
overdue_tasks_count = Task.objects.filter(
    assignee=request.user,
    deadline__lt=timezone.now()
).exclude(status='done').count()
```

### Виджет с истекающим сроком годности
```105:109:intranet/views.py
# Реагенты с истекающим сроком годности (следующие 30 дней)
expiring_soon = Reagent.objects.filter(
    expiry_date__lte=timezone.now().date() + timedelta(days=30),
    expiry_date__gte=timezone.now().date()
).order_by('expiry_date')[:5]
```

### Кликабельные ссылки

**get_absolute_url в моделях:**
```134:136:intranet/models.py
def get_absolute_url(self):
    """Возвращает URL для детальной страницы реагента"""
    return reverse('reagent_detail', kwargs={'pk': self.pk})
```

```263:264:intranet/models.py
def get_absolute_url(self):
    return reverse('recipe_detail', kwargs={'pk': self.pk})
```

```470:471:intranet/models.py
def get_absolute_url(self):
    return reverse('task_detail', kwargs={'pk': self.pk})
```

**Использование в шаблонах:**
```django
<a href="{{ task.get_absolute_url }}">{{ task.title }}</a>
<a href="{% url 'task_list' %}">Все задачи →</a>
```

---

## 3. Наполнение базы данных

### Скрипт для наполнения
```
Файл: create_test_data.py
```

Этот скрипт создает тестовые данные для всех таблиц проекта.

**Запуск:**
```bash
python create_test_data.py
```

### Минимум записей в таблицах

Проект содержит модели с тестовыми данными:
- **User** - пользователи с разными ролями
- **Reagent** - реагенты (минимум 10)
- **ReagentMovement** - движения реагентов
- **Recipe** - рецептуры
- **Culture** - клеточные культуры
- **Task** - задачи
- **Announcement** - объявления
- **DocumentTemplate** - документы

---

## 4. Данные из 3+ таблиц

### Dashboard выводит данные из 6 таблиц:

**1. Announcement (объявления):**
```81:84:intranet/views.py
latest_announcements = Announcement.objects.select_related('author').order_by(
    '-is_pinned', '-published_at'
)[:5]
```

**2. Task (задачи):**
```86:91:intranet/views.py
user_tasks = Task.objects.filter(
    assignee=request.user
).exclude(
    status='done'
).select_related('creator').order_by('deadline', '-priority')[:5]
```

**3. Reagent (реагенты):**
```99:109:intranet/views.py
critical_reagents = Reagent.objects.filter(
    on_hand__lt=F('min_threshold')
).order_by('on_hand')[:5]

expiring_soon = Reagent.objects.filter(
    expiry_date__lte=timezone.now().date() + timedelta(days=30),
    expiry_date__gte=timezone.now().date()
).order_by('expiry_date')[:5]
```

**4. Culture (культуры):**
```115:115:intranet/views.py
'active_cultures': Culture.objects.filter(status='active').count(),
```

**5. ReagentMovement (движения реагентов):**
```122:125:intranet/views.py
# Агрегация: общее количество движений по типам
movements_stats = ReagentMovement.objects.values('movement_type').annotate(
    total=Count('id')
)
```

**6. User (через related объекты):**
```82:82:intranet/views.py
latest_announcements = Announcement.objects.select_related('author')
```

---

## 5. Примеры QuerySet

### filter()
```54:57:intranet/views.py
reagents = Reagent.objects.filter(
    Q(name__icontains=search_query) | 
    Q(category__contains=search_query)
).values('id', 'name', 'category')[:5]
```

```87:91:intranet/views.py
user_tasks = Task.objects.filter(
    assignee=request.user
).exclude(
    status='done'
).select_related('creator').order_by('deadline', '-priority')[:5]
```

### exclude()
```89:91:intranet/views.py
).exclude(
    status='done'
).select_related('creator').order_by('deadline', '-priority')[:5]
```

```94:97:intranet/views.py
overdue_tasks_count = Task.objects.filter(
    assignee=request.user,
    deadline__lt=timezone.now()
).exclude(status='done').count()
```

### order_by()
```82:84:intranet/views.py
latest_announcements = Announcement.objects.select_related('author').order_by(
    '-is_pinned', '-published_at'
)[:5]
```

```101:103:intranet/views.py
critical_reagents = Reagent.objects.filter(
    on_hand__lt=F('min_threshold')
).order_by('on_hand')[:5]
```

### all()
```169:169:intranet/views.py
reagents_list = Reagent.objects.all()
```

```128:128:intranet/views.py
all_announcements = Announcement.objects.all().order_by('-published_at')
```

### get()
```211:213:intranet/views.py
reagent = get_object_or_404(
    Reagent.objects.prefetch_related('movements__user'),
    pk=pk
)
```

### distinct()
```397:397:intranet/views.py
categories = Reagent.objects.values_list('category', flat=True).distinct()
```

---

## 6. Агрегатные функции

### COUNT - Подсчет количества
```13:13:intranet/views.py
from django.db.models import Q, Count, F, Avg, Sum
```

```122:125:intranet/views.py
# Агрегация: общее количество движений по типам
movements_stats = ReagentMovement.objects.values('movement_type').annotate(
    total=Count('id')
)
```

**Результат:**
```python
[
    {'movement_type': 'in', 'total': 45},
    {'movement_type': 'out', 'total': 32}
]
```

### Простой count()
```112:119:intranet/views.py
# СТАТИСТИКА с агрегацией
stats = {
    'total_reagents': Reagent.objects.count(),
    'total_tasks': Task.objects.filter(assignee=request.user).count(),
    'active_cultures': Culture.objects.filter(status='active').count(),
    'pending_tasks': Task.objects.filter(
        assignee=request.user,
        status='new'
    ).count(),
}
```

### В шаблонных тегах
```18:26:intranet/templatetags/intranet_tags.py
@register.simple_tag
def count_pending_tasks(user=None):
    """
    Подсчитывает количество незавершенных задач
    Если передан пользователь, считает только его задачи
    """
    tasks = Task.objects.exclude(status='done')
    if user and user.is_authenticated:
        tasks = tasks.filter(assignee=user)
    return tasks.count()
```

---

## 7. Поиск данных

### Форма поиска
```480:504:intranet/forms.py
class SearchForm(forms.Form):
    """
    Универсальная форма поиска для дашборда
    """
    q = forms.CharField(
        label='Поиск',
        required=False,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'Поиск...',
            'autocomplete': 'off'
        })
    )
    
    search_type = forms.ChoiceField(
        label='Искать в',
        required=False,
        choices=[
            ('all', 'Везде'),
            ('reagents', 'Реагенты'),
            ('tasks', 'Задачи'),
            ('announcements', 'Объявления'),
        ],
        widget=forms.Select(attrs={'class': 'form-select'})
    )
```

### Реализация поиска в dashboard
```48:80:intranet/views.py
# Обработка поиска
search_query = request.GET.get('q', '')
search_results = []

if search_query:
    # Поиск реагентов
    reagents = Reagent.objects.filter(
        Q(name__icontains=search_query) | 
        Q(category__contains=search_query)
    ).values('id', 'name', 'category')[:5]
    
    # Поиск задач
    tasks = Task.objects.filter(
        Q(title__icontains=search_query) |
        Q(description__icontains=search_query)
    ).values_list('id', 'title', 'status')[:5]
    
    # Поиск объявлений
    announcements_found = Announcement.objects.filter(
        Q(title__icontains=search_query) |
        Q(text__icontains=search_query)
    )
    
    search_results = {
        'reagents': list(reagents),
        'tasks': list(tasks),
        'announcements_count': announcements_found.count(),
        'announcements_exist': announcements_found.exists(),
    }
    
    # Сохраняем последний поиск в сессию
    request.session['last_search'] = search_query
```

**Использование Q объектов для OR условий:**
- `Q(name__icontains=search_query) | Q(category__contains=search_query)`
- Поиск в нескольких полях одновременно

---

## 8. Авторизация

### Проверка авторизации
```35:36:intranet/views.py
@login_required
@cache_page(60 * 5)
def dashboard(request):
```

### Отображение пользователя
```87:88:intranet/views.py
user_tasks = Task.objects.filter(
    assignee=request.user
```

### Логин view
```416:448:intranet/views.py
def login_view(request):
    """
    Вход в систему
    """
    if request.user.is_authenticated:
        return redirect('dashboard')
    
    if request.method == 'POST':
        form = UserLoginForm(data=request.POST)
        if form.is_valid():
            username = form.cleaned_data['username']
            password = form.cleaned_data['password']
            user = authenticate(request, username=username, password=password)
            
            if user is not None:
                login(request, user)
                
                # Сохраняем время входа в сессию
                request.session['login_time'] = timezone.now().isoformat()
                
                messages.success(request, f'Добро пожаловать, {user.get_full_name() or user.username}!')
                
                # Перенаправление на следующую страницу или дашборд
                next_url = request.GET.get('next', 'dashboard')
                return redirect(next_url)
    else:
        form = UserLoginForm()
    
    context = {
        'form': form,
    }
    
    return render(request, 'auth/login.html', context)
```

### Logout view
```451:457:intranet/views.py
def logout_view(request):
    """
    Выход из системы
    """
    logout(request)
    messages.info(request, 'Вы вышли из системы')
    return redirect('login')
```

### В шаблонах
```django
{% if user.is_authenticated %}
    <p>Привет, {{ user.get_full_name|default:user.username }}!</p>
    <a href="{% url 'logout' %}">Выйти</a>
{% else %}
    <a href="{% url 'login' %}">Войти</a>
{% endif %}
```

### Шаблонный тег с приветствием
```63:85:intranet/templatetags/intranet_tags.py
@register.simple_tag(takes_context=True)
def user_greeting(context):
    """
    Возвращает приветствие для текущего пользователя
    """
    user = context.get('user')
    if user and user.is_authenticated:
        name = user.get_full_name() or user.username
        role_display = user.get_role_display() if hasattr(user, 'get_role_display') else ''
        
        # Определяем время суток для приветствия
        hour = timezone.now().hour
        if 5 <= hour < 12:
            greeting = 'Доброе утро'
        elif 12 <= hour < 18:
            greeting = 'Добрый день'
        elif 18 <= hour < 23:
            greeting = 'Добрый вечер'
        else:
            greeting = 'Доброй ночи'
        
        return f'{greeting}, {name}!'
    return 'Здравствуйте!'
```

---

## 9. User-friendly дизайн

### Bootstrap классы
```26:29:intranet/forms.py
widget=forms.TextInput(attrs={
    'class': 'form-control',
    'placeholder': 'Введите имя пользователя'
})
```

### CSS файлы проекта
```
static/css/custom.css
static/css/recipe-form.css
```

### JavaScript файлы
```
static/js/main.js
static/js/recipe-form.js
```

### Responsive дизайн
- Использование Bootstrap для адаптивной верстки
- Классы `form-control`, `form-select`, `btn`, `card` и т.д.

---

## 10. DEBUG=False режим

### Настройка в settings.py
```21:24:ddc_intranet/settings.py
# SECURITY WARNING: don't run with debug turned on in production!
# Для разработки: DEBUG = True
# Для демонстрации "боевого" режима: DEBUG = False
DEBUG = True
```

**Для продакшна изменить на:**
```python
DEBUG = False
```

### Кастомные обработчики ошибок
```28:30:ddc_intranet/urls.py
# Кастомные обработчики ошибок
handler404 = 'intranet.views.custom_404'
handler500 = 'intranet.views.custom_500'
```

```623:627:intranet/views.py
def custom_404(request, exception):
    """
    Кастомная страница 404
    """
    return render(request, '404.html', status=404)
```

```630:634:intranet/views.py
def custom_500(request):
    """
    Кастомная страница 500
    """
    return render(request, '500.html', status=500)
```

### ALLOWED_HOSTS
```26:26:ddc_intranet/settings.py
ALLOWED_HOSTS = ['localhost', '127.0.0.1', '*']
```

**Для продакшна указать конкретные домены:**
```python
ALLOWED_HOSTS = ['yourdomain.com', 'www.yourdomain.com']
```

---

## Итоговая таблица

| Пункт | Реализация | Файл:Строки |
|-------|-----------|-------------|
| **1. Цель и виджеты** | 3 виджета на dashboard | views.py:81-109 |
| **2. Кликабельные ссылки** | get_absolute_url в моделях | models.py:134-136, 263-264, 470-471 |
| **3. Наполнение БД** | create_test_data.py | create_test_data.py |
| **4. Данные из 3+ таблиц** | 6 таблиц в dashboard | views.py:81-125 |
| **5. QuerySet примеры** | filter, exclude, order_by, all, get, distinct | views.py:54-213 |
| **6. Агрегация** | Count, annotate | views.py:122-125 |
| **7. Поиск** | SearchForm + Q объекты | views.py:48-80, forms.py:480-504 |
| **8. Авторизация** | login_required, login/logout views | views.py:35-36, 416-457 |
| **9. UX дизайн** | Bootstrap, CSS, JS | forms.py, static/ |
| **10. DEBUG=False** | Кастомные ошибки 404/500 | urls.py:28-30, views.py:623-634 |

---

## Контрольные вопросы

1. **Сколько виджетов на главной странице?** - 3+ (объявления, задачи, критические реагенты)
2. **Какие таблицы используются?** - Announcement, Task, Reagent, Culture, ReagentMovement, User
3. **Какая агрегатная функция используется?** - Count() для подсчета движений
4. **Как реализован поиск?** - Q объекты + __icontains для поиска в нескольких полях
5. **Где проверяется авторизация?** - @login_required декоратор + request.user.is_authenticated
6. **Что нужно изменить для DEBUG=False?** - DEBUG=False, ALLOWED_HOSTS, настроить статику

