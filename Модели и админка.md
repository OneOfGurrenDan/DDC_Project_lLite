# Модели и админка - Защита лабораторной работы

## Содержание
1. [list_display](#list_display)
2. [list_display с собственным методом](#list_display-с-собственным-методом)
3. [list_filter](#list_filter)
4. [inlines](#inlines)
5. [date_hierarchy](#date_hierarchy)
6. [@admin.display](#admindisplay)
7. [short_description](#short_description)
8. [filter_horizontal](#filter_horizontal)
9. [list_display_links](#list_display_links)
10. [raw_id_fields](#raw_id_fields)
11. [readonly_fields](#readonly_fields)
12. [search_fields](#search_fields)

---

## list_display

**Что это?**  
Атрибут `list_display` определяет, какие поля модели будут отображаться в виде колонок в списке объектов на странице администрирования.

**Назначение:**
- Настройка отображения данных в табличном виде
- Улучшение читаемости списка объектов
- Быстрый доступ к ключевым полям

**Пример:**
```python
class BookAdmin(admin.ModelAdmin):
    list_display = ('title', 'author', 'published_date', 'price')
```

**Что можно использовать:**
- Названия полей модели
- Методы модели
- Методы класса админки
- Callable функции

---

## list_display с собственным методом

**Что это?**  
В `list_display` можно использовать собственные методы для вычисления или форматирования данных, которых нет в модели напрямую.

**Назначение:**
- Вычисление значений на лету
- Форматирование данных
- Объединение нескольких полей
- Добавление HTML-разметки

**Пример:**
```python
class BookAdmin(admin.ModelAdmin):
    list_display = ('title', 'author', 'full_info', 'is_available')
    
    def full_info(self, obj):
        return f"{obj.title} by {obj.author} ({obj.published_date.year})"
    full_info.short_description = 'Полная информация'
    
    def is_available(self, obj):
        return obj.stock > 0
    is_available.boolean = True
    is_available.short_description = 'В наличии'
```

**Параметры метода:**
- `self` - экземпляр admin класса
- `obj` - экземпляр модели

---

## list_filter

**Что это?**  
Атрибут `list_filter` добавляет боковую панель фильтрации на странице списка объектов.

**Назначение:**
- Фильтрация объектов по определенным полям
- Улучшение навигации в больших списках
- Быстрый поиск по категориям

**Пример:**
```python
class BookAdmin(admin.ModelAdmin):
    list_filter = ('published_date', 'author', 'genre', 'is_active')
```

**Типы полей для фильтрации:**
- BooleanField - да/нет
- DateField/DateTimeField - по временным периодам
- ForeignKey - по связанным объектам
- CharField с choices - по вариантам выбора

**Кастомный фильтр:**
```python
class PriceFilter(admin.SimpleListFilter):
    title = 'диапазон цен'
    parameter_name = 'price'
    
    def lookups(self, request, model_admin):
        return (
            ('cheap', 'До 500₽'),
            ('medium', '500-1000₽'),
            ('expensive', 'Более 1000₽'),
        )
    
    def queryset(self, request, queryset):
        if self.value() == 'cheap':
            return queryset.filter(price__lt=500)
        if self.value() == 'medium':
            return queryset.filter(price__gte=500, price__lte=1000)
        if self.value() == 'expensive':
            return queryset.filter(price__gt=1000)
```

---

## inlines

**Что это?**  
Возможность редактирования связанных объектов на одной странице с родительским объектом.

**Назначение:**
- Работа со связанными моделями (ForeignKey, ManyToMany)
- Удобное управление зависимыми данными
- Уменьшение количества переходов между страницами

**Пример:**
```python
class ChapterInline(admin.TabularInline):
    model = Chapter
    extra = 1  # Количество пустых форм для добавления
    fields = ('title', 'page_number', 'content')

class BookAdmin(admin.ModelAdmin):
    inlines = [ChapterInline]
```

**Типы Inline:**
- `TabularInline` - компактное табличное представление
- `StackedInline` - вертикальное представление с полями друг под другом

**Параметры:**
- `extra` - количество пустых форм
- `max_num` - максимальное количество форм
- `can_delete` - разрешить удаление
- `show_change_link` - показать ссылку на редактирование

---

## date_hierarchy

**Что это?**  
Навигация по датам в верхней части страницы списка объектов.

**Назначение:**
- Быстрая фильтрация по датам
- Иерархическая навигация (год → месяц → день)
- Удобный просмотр данных с временной привязкой

**Пример:**
```python
class BookAdmin(admin.ModelAdmin):
    date_hierarchy = 'published_date'
```

**Особенности:**
- Работает только с полями DateField или DateTimeField
- Можно указать только одно поле
- Создает breadcrumb-навигацию по годам/месяцам/дням
- Автоматически группирует записи

---

## @admin.display

**Что это?**  
Декоратор для настройки отображения методов в `list_display` (современная замена атрибутов метода).

**Назначение:**
- Настройка описания колонки
- Указание порядка сортировки
- Добавление булевых иконок
- Более чистый и читаемый код

**Пример:**
```python
class BookAdmin(admin.ModelAdmin):
    list_display = ('title', 'author_full_name', 'is_new_release')
    
    @admin.display(description='Автор', ordering='author__last_name')
    def author_full_name(self, obj):
        return f"{obj.author.first_name} {obj.author.last_name}"
    
    @admin.display(description='Новинка', boolean=True)
    def is_new_release(self, obj):
        from django.utils import timezone
        from datetime import timedelta
        return obj.published_date > timezone.now() - timedelta(days=90)
```

**Параметры декоратора:**
- `description` - название колонки
- `ordering` - поле для сортировки
- `boolean` - отображать как булевую иконку
- `empty_value` - значение для пустых полей

---

## short_description

**Что это?**  
Атрибут метода для установки названия колонки в list_display (старый способ, до Django 3.2).

**Назначение:**
- Задать понятное название колонки
- Заменить техническое имя метода на читаемое
- Поддержка локализации

**Пример:**
```python
class BookAdmin(admin.ModelAdmin):
    list_display = ('title', 'days_since_published')
    
    def days_since_published(self, obj):
        from django.utils import timezone
        delta = timezone.now().date() - obj.published_date
        return delta.days
    days_since_published.short_description = 'Дней с публикации'
```

**Примечание:**  
В современных версиях Django (3.2+) рекомендуется использовать декоратор `@admin.display(description='...')`.

---

## filter_horizontal

**Что это?**  
Виджет для удобного управления связями ManyToMany с двумя списками и кнопками перемещения.

**Назначение:**
- Удобное управление множественными связями
- Визуальное перемещение элементов между списками
- Поиск в списках
- Альтернатива стандартному множественному select

**Пример:**
```python
class BookAdmin(admin.ModelAdmin):
    filter_horizontal = ('genres', 'tags')
```

**Альтернатива:**
- `filter_vertical` - вертикальное расположение списков

**Когда использовать:**
- Для полей ManyToManyField
- Когда связанных объектов много
- Когда нужен поиск по списку

---

## list_display_links

**Что это?**  
Определяет, какие поля в list_display будут ссылками на страницу редактирования объекта.

**Назначение:**
- Настройка кликабельных полей
- Улучшение UX администратора
- Возможность сделать несколько ссылок

**Пример:**
```python
class BookAdmin(admin.ModelAdmin):
    list_display = ('title', 'author', 'isbn', 'published_date')
    list_display_links = ('title', 'isbn')  # Оба поля - ссылки
```

**Особенности:**
- По умолчанию первое поле в list_display является ссылкой
- Можно указать несколько полей
- Можно отключить все ссылки: `list_display_links = None` (требуется `list_editable`)

---

## raw_id_fields

**Что это?**  
Замена выпадающего списка ForeignKey на поле ввода ID с кнопкой поиска (lookup).

**Назначение:**
- Оптимизация для связей с большим количеством объектов
- Уменьшение нагрузки на базу данных
- Ускорение загрузки страницы администрирования

**Пример:**
```python
class BookAdmin(admin.ModelAdmin):
    raw_id_fields = ('author', 'publisher')
```

**Преимущества:**
- Не загружает все связанные объекты в select
- Окно поиска для выбора объекта
- Показывает ID выбранного объекта
- Критично для таблиц с тысячами записей

**Интерфейс:**
- Поле ввода с иконкой лупы
- Клик по лупе открывает popup со списком объектов
- Поддержка поиска и фильтрации в popup

---

## readonly_fields

**Что это?**  
Список полей, которые будут отображаться в режиме только для чтения на странице редактирования.

**Назначение:**
- Показать данные, которые нельзя редактировать
- Отображение вычисляемых полей
- Защита критичных данных от изменений
- Показ служебной информации

**Пример:**
```python
class BookAdmin(admin.ModelAdmin):
    readonly_fields = ('created_at', 'updated_at', 'total_reviews', 'average_rating')
    
    def total_reviews(self, obj):
        return obj.reviews.count()
    total_reviews.short_description = 'Всего отзывов'
    
    def average_rating(self, obj):
        from django.db.models import Avg
        avg = obj.reviews.aggregate(Avg('rating'))['rating__avg']
        return f"{avg:.2f}" if avg else "Нет оценок"
    average_rating.short_description = 'Средняя оценка'
```

**Использование:**
- Автоматические поля (created_at, modified_at)
- Вычисляемые значения
- Методы модели
- Методы admin класса

---

## search_fields

**Что это?**  
Список полей, по которым будет выполняться поиск через строку поиска в админке.

**Назначение:**
- Добавление функционала поиска
- Поиск по нескольким полям одновременно
- Поиск по связанным моделям

**Пример:**
```python
class BookAdmin(admin.ModelAdmin):
    search_fields = ('title', 'author__last_name', 'isbn', 'description')
```

**Модификаторы поиска:**
```python
search_fields = (
    'title',                    # LIKE %title%
    '^title',                   # LIKE title% (начинается с)
    '=isbn',                    # Точное совпадение
    '@description',             # Full-text search (PostgreSQL)
)
```

**Поиск по связанным моделям:**
```python
search_fields = (
    'title',
    'author__first_name',       # Поиск по имени автора
    'author__last_name',        # Поиск по фамилии автора
    'publisher__name',          # Поиск по названию издателя
)
```

**Особенности:**
- Поиск регистронезависимый (case-insensitive)
- Использует OR между полями (поиск хотя бы в одном поле)
- Можно искать по полям связанных моделей через `__`

---

## Полный пример использования всех возможностей

```python
from django.contrib import admin
from django.utils import timezone
from datetime import timedelta
from .models import Book, Chapter, Author

# Inline для глав книги
class ChapterInline(admin.TabularInline):
    model = Chapter
    extra = 1
    fields = ('title', 'page_number')
    readonly_fields = ('created_at',)

# Кастомный фильтр
class PublicationYearFilter(admin.SimpleListFilter):
    title = 'год публикации'
    parameter_name = 'pub_year'
    
    def lookups(self, request, model_admin):
        return (
            ('recent', 'Последние 5 лет'),
            ('old', 'Старше 5 лет'),
        )
    
    def queryset(self, request, queryset):
        if self.value() == 'recent':
            cutoff = timezone.now().date() - timedelta(days=365*5)
            return queryset.filter(published_date__gte=cutoff)
        if self.value() == 'old':
            cutoff = timezone.now().date() - timedelta(days=365*5)
            return queryset.filter(published_date__lt=cutoff)

@admin.register(Book)
class BookAdmin(admin.ModelAdmin):
    # Отображение колонок
    list_display = (
        'title', 
        'author_name', 
        'published_date', 
        'is_new', 
        'review_count',
        'price'
    )
    
    # Кликабельные поля
    list_display_links = ('title', 'author_name')
    
    # Фильтры
    list_filter = (
        'published_date', 
        PublicationYearFilter,
        'author',
        'is_active'
    )
    
    # Поиск
    search_fields = (
        'title', 
        '^isbn',
        'author__first_name', 
        'author__last_name',
        '@description'
    )
    
    # Иерархия дат
    date_hierarchy = 'published_date'
    
    # Поля только для чтения
    readonly_fields = (
        'created_at', 
        'updated_at', 
        'full_info',
        'days_since_publication'
    )
    
    # Оптимизация для больших связей
    raw_id_fields = ('publisher',)
    
    # Множественные связи
    filter_horizontal = ('genres', 'tags')
    
    # Inline редактирование связанных объектов
    inlines = [ChapterInline]
    
    # Организация полей на странице
    fieldsets = (
        ('Основная информация', {
            'fields': ('title', 'author', 'isbn', 'description')
        }),
        ('Публикация', {
            'fields': ('publisher', 'published_date', 'price')
        }),
        ('Категории', {
            'fields': ('genres', 'tags')
        }),
        ('Служебная информация', {
            'classes': ('collapse',),
            'fields': ('created_at', 'updated_at', 'full_info', 'days_since_publication')
        }),
    )
    
    # Методы с декоратором @admin.display
    @admin.display(description='Автор', ordering='author__last_name')
    def author_name(self, obj):
        return f"{obj.author.first_name} {obj.author.last_name}"
    
    @admin.display(description='Новинка', boolean=True)
    def is_new(self, obj):
        cutoff = timezone.now().date() - timedelta(days=90)
        return obj.published_date > cutoff
    
    @admin.display(description='Отзывов')
    def review_count(self, obj):
        return obj.reviews.count()
    
    # Методы со старым способом (short_description)
    def full_info(self, obj):
        return f"{obj.title} | {obj.author} | {obj.published_date.year}"
    full_info.short_description = 'Полная информация'
    
    def days_since_publication(self, obj):
        delta = timezone.now().date() - obj.published_date
        return f"{delta.days} дней"
    days_since_publication.short_description = 'Дней с публикации'
```

---

## Шпаргалка для защиты

| Параметр | Назначение | Пример |
|----------|-----------|---------|
| `list_display` | Колонки в списке | `('title', 'author')` |
| `list_filter` | Фильтры сбоку | `('date', 'status')` |
| `search_fields` | Поля для поиска | `('title', '^isbn')` |
| `date_hierarchy` | Навигация по датам | `'published_date'` |
| `list_display_links` | Кликабельные поля | `('title', 'id')` |
| `readonly_fields` | Только чтение | `('created_at',)` |
| `filter_horizontal` | ManyToMany виджет | `('tags', 'genres')` |
| `raw_id_fields` | Lookup для FK | `('author',)` |
| `inlines` | Вложенное редактирование | `[ChapterInline]` |
| `@admin.display` | Декоратор для методов | `@admin.display(description='')` |
| `short_description` | Название колонки (старый способ) | `method.short_description = ''` |


