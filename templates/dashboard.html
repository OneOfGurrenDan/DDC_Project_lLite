{% extends 'base.html' %}
{% load intranet_tags %}

{% block title %}Главная - DDC Biotech Интранет{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">{% user_greeting %}</h1>
    </div>
</div>

<!-- Форма поиска -->
<div class="row mb-4">
    <div class="col-md-8 offset-md-2">
        <form method="get" action="{% url 'dashboard' %}" class="card shadow-sm">
            <div class="card-body">
                <div class="input-group input-group-lg">
                    <input type="text" name="q" class="form-control" placeholder="Поиск по реагентам, задачам, объявлениям..." value="{{ search_query }}">
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-search"></i> Найти
                    </button>
                </div>
            </div>
        </form>
        
        {% if search_results %}
        <div class="card mt-3 shadow-sm">
            <div class="card-body">
                <h5>Результаты поиска для "{{ search_query }}":</h5>
                
                {% if search_results.reagents %}
                <h6 class="mt-3">Реагенты:</h6>
                <ul>
                    {% for reagent in search_results.reagents %}
                    <li>{{ reagent.name }} ({{ reagent.category }})</li>
                    {% endfor %}
                </ul>
                {% endif %}
                
                {% if search_results.tasks %}
                <h6 class="mt-3">Задачи:</h6>
                <ul>
                    {% for task_id, task_title, task_status in search_results.tasks %}
                    <li>{{ task_title }} - {{ task_status }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                
                {% if search_results.announcements_exist %}
                <p class="mt-3">Найдено объявлений: {{ search_results.announcements_count }}</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Статистика -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary shadow">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Реагенты</h6>
                        <h2>{{ stats.total_reagents }}</h2>
                    </div>
                    <i class="bi bi-flask" style="font-size: 3rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success shadow">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Активные культуры</h6>
                        <h2>{{ stats.active_cultures }}</h2>
                    </div>
                    <i class="bi bi-droplet" style="font-size: 3rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning shadow">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Новые задачи</h6>
                        <h2>{{ stats.pending_tasks }}</h2>
                    </div>
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info shadow">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Всего задач</h6>
                        <h2>{{ stats.total_tasks }}</h2>
                    </div>
                    <i class="bi bi-check2-square" style="font-size: 3rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ВИДЖЕТ 1: Последние объявления -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-megaphone"></i> Объявления</h5>
            </div>
            <div class="card-body">
                {% if latest_announcements %}
                {% for announcement in latest_announcements %}
                <div class="mb-3 {% if not forloop.last %}border-bottom pb-3{% endif %}">
                    {% if announcement.is_pinned %}
                    <span class="badge bg-warning text-dark"><i class="bi bi-pin-angle-fill"></i> Закреплено</span>
                    {% endif %}
                    <h6 class="mt-2">{{ announcement.title }}</h6>
                    <p class="text-muted mb-1">{{ announcement.text|truncatechars:200 }}</p>
                    <small class="text-muted">
                        Автор: {{ announcement.author.get_full_name|default:announcement.author.username }} | 
                        {{ announcement.published_at|date:"d.m.Y H:i" }}
                    </small>
                </div>
                {% endfor %}
                <a href="{% url 'announcement_list' %}" class="btn btn-sm btn-outline-primary">
                    Все объявления →
                </a>
                {% else %}
                <p class="text-muted">Нет объявлений</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ВИДЖЕТ 2: Мои задачи -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-check2-square"></i> Мои задачи</h5>
            </div>
            <div class="card-body">
                {% if user_tasks %}
                <div class="list-group list-group-flush">
                    {% for task in user_tasks %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ task.title }}</h6>
                                <small class="text-muted">
                                    Создатель: {{ task.creator.username|default:"—" }}
                                </small>
                            </div>
                            <div>
                                <span class="badge {{ task.status|status_badge }}">{{ task.get_status_display }}</span>
                                <span class="badge {{ task.priority|priority_badge }}">{{ task.get_priority_display }}</span>
                            </div>
                        </div>
                        {% if task.deadline %}
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> 
                            Срок: {{ task.deadline|date:"d.m.Y H:i" }}
                            {% with days=task.deadline|days_until %}
                            {% if days < 0 %}
                            <span class="badge bg-danger">Просрочено</span>
                            {% elif days == 0 %}
                            <span class="badge bg-warning">Сегодня</span>
                            {% elif days <= 3 %}
                            <span class="badge bg-warning">Через {{ days }} дн.</span>
                            {% endif %}
                            {% endwith %}
                        </small>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% if overdue_tasks_count > 0 %}
                <div class="alert alert-danger mt-3 mb-0">
                    <i class="bi bi-exclamation-triangle"></i> У вас {{ overdue_tasks_count }} просроченных {{ overdue_tasks_count|pluralize_ru:"задача,задачи,задач" }}
                </div>
                {% endif %}
                <a href="{% url 'task_list' %}" class="btn btn-sm btn-outline-success mt-3">
                    Все задачи →
                </a>
                {% else %}
                <p class="text-muted">Нет активных задач</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ВИДЖЕТ 3: Критические реагенты -->
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Критические реагенты</h5>
            </div>
            <div class="card-body">
                {% if critical_reagents %}
                <h6>Низкий остаток:</h6>
                <div class="list-group list-group-flush mb-3">
                    {% for reagent in critical_reagents %}
                    <a href="{% url 'reagent_detail' reagent.pk %}" class="list-group-item list-group-item-action">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ reagent.name }}</strong>
                                <br>
                                <small class="text-muted">{{ reagent.get_category_display }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-danger">{{ reagent.on_hand }}</span>
                                <br>
                                <small class="text-muted">мин: {{ reagent.min_threshold }}</small>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">Все реагенты в норме</p>
                {% endif %}
                
                {% if expiring_soon %}
                <h6 class="mt-3">Истекает срок годности:</h6>
                <div class="list-group list-group-flush">
                    {% for reagent in expiring_soon %}
                    <a href="{% url 'reagent_detail' reagent.pk %}" class="list-group-item list-group-item-action">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ reagent.name }}</strong>
                            </div>
                            <div>
                                <small class="text-danger">
                                    <i class="bi bi-calendar-x"></i> {{ reagent.expiry_date|date:"d.m.Y" }}
                                    ({{ reagent.expiry_date|days_until }} дн.)
                                </small>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
                
                <a href="{% url 'object_list' %}" class="btn btn-sm btn-outline-danger mt-3">
                    Все реагенты →
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Статистика по движениям -->
{% if movements_stats %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Статистика движений реагентов</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for stat in movements_stats %}
                    <div class="col-md-6">
                        <p><strong>{{ stat.movement_type|title }}:</strong> {{ stat.total }} операций</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}


