# Разработка страницы конкретного объекта - Навигация

## Содержание

1. [Выбор объекта для реализации](#1-выбор-объекта)
2. [Переход через меню](#2-переход-через-меню)
3. [Отображение данных (ключевая + связанная таблица)](#3-отображение-данных)
4. [URL с параметром ID](#4-url-с-параметром-id)
5. [Редактирование объекта](#5-редактирование-объекта)
6. [Удаление объекта](#6-удаление-объекта)
7. [Добавление объекта](#7-добавление-объекта)
8. [Демонстрация CRUD](#8-демонстрация-crud)
9. [Права доступа](#9-права-доступа)
10. [Наполнение БД](#10-наполнение-бд)
11. [User-friendly дизайн](#11-user-friendly-дизайн)

---

## 1. Выбор объекта

### Выбран объект: Reagent (Реагент)

**Модель:**
```66:148:intranet/models.py
class Reagent(models.Model):
    """
    Модель реагента/химического вещества
    """
    CATEGORY_CHOICES = [
        ('buffer', 'Буфер'),
        ('enzyme', 'Фермент'),
        ('antibody', 'Антитело'),
        ('chemical', 'Химическое вещество'),
        ('media', 'Среда'),
        ('other', 'Прочее'),
    ]
    
    name = models.CharField('Название', max_length=255)
    category = models.CharField(
        'Категория',
        max_length=20,
        choices=CATEGORY_CHOICES
    )
    on_hand = models.DecimalField(
        'Остаток',
        max_digits=10,
        decimal_places=2,
        default=0
    )
    min_threshold = models.DecimalField(
        'Минимальный порог',
        max_digits=10,
        decimal_places=2,
        default=0
    )
    expiry_date = models.DateField(
        'Срок годности',
        null=True,
        blank=True
    )
    image = models.ImageField(
        'Изображение',
        upload_to='reagents/',
        blank=True,
        null=True
    )
    certificate = models.FileField(
        'Сертификат',
        upload_to='certificates/',
        blank=True,
        null=True
    )
    external_link = models.URLField(
        'Внешняя ссылка',
        blank=True,
        null=True
    )
    created_at = models.DateTimeField('Дата создания', auto_now_add=True)
    updated_at = models.DateTimeField('Дата обновления', auto_now=True)
```

**Связанная модель - ReagentMovement:**
```150:214:intranet/models.py
class ReagentMovement(models.Model):
    """
    Модель движения реагентов (приход/расход)
    """
    MOVEMENT_CHOICES = [
        ('in', 'Приход'),
        ('out', 'Расход'),
    ]
    
    reagent = models.ForeignKey(
        Reagent,
        on_delete=models.CASCADE,
        related_name='movements',
        verbose_name='Реагент'
    )
    quantity = models.DecimalField(
        'Количество',
        max_digits=10,
        decimal_places=2
    )
    movement_type = models.CharField(
        'Тип движения',
        max_length=10,
        choices=MOVEMENT_CHOICES
    )
    date = models.DateTimeField('Дата', default=timezone.now)
    comment = models.TextField('Комментарий', blank=True)
    user = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        related_name='reagent_movements',
        verbose_name='Пользователь'
    )
```

---

## 2. Переход через меню

### URL маршруты
```23:28:intranet/urls.py
# CRUD ОБЪЕКТОВ (РЕАГЕНТЫ)
path('objects/', views.object_list, name='object_list'),
path('objects/<int:pk>/', views.object_detail, name='reagent_detail'),
path('objects/create/', views.object_create, name='object_create'),
path('objects/<int:pk>/edit/', views.object_update, name='object_update'),
path('objects/<int:pk>/delete/', views.object_delete, name='object_delete'),
```

### Навигация в шаблонах
```django
{# Ссылка на список объектов #}
<a href="{% url 'object_list' %}">Реагенты</a>

{# Ссылка на конкретный объект #}
<a href="{% url 'reagent_detail' pk=reagent.pk %}">{{ reagent.name }}</a>

{# Или через get_absolute_url #}
<a href="{{ reagent.get_absolute_url }}">{{ reagent.name }}</a>
```

---

## 3. Отображение данных

### View для детальной страницы
```201:235:intranet/views.py
@login_required
def object_detail(request, pk):
    """
    Детальная страница реагента
    
    Демонстрирует:
    - get_object_or_404()
    - select_related(), prefetch_related()
    """
    # Получаем реагент с предзагрузкой связанных данных
    reagent = get_object_or_404(
        Reagent.objects.prefetch_related('movements__user'),
        pk=pk
    )
    
    # Получаем последние движения
    recent_movements = reagent.movements.all()[:10]
    
    # Рецепты, использующие этот реагент
    recipes = reagent.used_in_recipes.all().select_related('author')
    
    # Проверка прав доступа (пример)
    user_role = request.user.role
    can_edit = user_role in ['lab_head', 'sysadmin']
    can_delete = user_role == 'sysadmin'
    
    context = {
        'object': reagent,
        'recent_movements': recent_movements,
        'recipes': recipes,
        'can_edit': can_edit,
        'can_delete': can_delete,
    }
    
    return render(request, 'object_detail.html', context)
```

**Данные из связанных таблиц:**
- **Ключевая:** Reagent (reagent)
- **Связанная 1:** ReagentMovement (movements) - через related_name
- **Связанная 2:** Recipe (used_in_recipes) - через ManyToMany
- **Связанная 3:** User (через movements__user) - авторы движений

---

## 4. URL с параметром ID

### Django path с <int:pk>
```25:25:intranet/urls.py
path('objects/<int:pk>/', views.object_detail, name='reagent_detail'),
```

**Примеры URL:**
- `/objects/1/` - реагент с ID=1
- `/objects/25/` - реагент с ID=25

### get_absolute_url в модели
```134:136:intranet/models.py
def get_absolute_url(self):
    """Возвращает URL для детальной страницы реагента"""
    return reverse('reagent_detail', kwargs={'pk': self.pk})
```

**Использование:**
```python
reagent = Reagent.objects.get(pk=5)
url = reagent.get_absolute_url()  # '/objects/5/'
```

---

## 5. Редактирование объекта

### View для редактирования
```270:301:intranet/views.py
@login_required
def object_update(request, pk):
    """
    Редактирование реагента
    
    Демонстрирует:
    - save(commit=True)
    - частичное редактирование полей
    """
    reagent = get_object_or_404(Reagent, pk=pk)
    
    # Проверка прав
    if request.user.role not in ['lab_head', 'sysadmin']:
        messages.error(request, 'У вас нет прав для редактирования реагентов')
        return redirect('reagent_detail', pk=pk)
    
    if request.method == 'POST':
        form = ReagentForm(request.POST, request.FILES, instance=reagent)
        if form.is_valid():
            updated_reagent = form.save(commit=True)
            messages.success(request, f'Реагент "{updated_reagent.name}" обновлен')
            return HttpResponseRedirect(updated_reagent.get_absolute_url())
    else:
        form = ReagentForm(instance=reagent)
    
    context = {
        'form': form,
        'title': f'Редактировать: {reagent.name}',
        'object': reagent,
    }
    
    return render(request, 'forms/object_form.html', context)
```

### URL для редактирования
```27:27:intranet/urls.py
path('objects/<int:pk>/edit/', views.object_update, name='object_update'),
```

**Пример:** `/objects/5/edit/`

---

## 6. Удаление объекта

### View для удаления
```304:329:intranet/views.py
@login_required
def object_delete(request, pk):
    """
    Удаление реагента
    
    Демонстрирует:
    - delete()
    - HttpResponseRedirect
    """
    reagent = get_object_or_404(Reagent, pk=pk)
    
    # Проверка прав
    if request.user.role != 'sysadmin':
        raise Http404("Только системный администратор может удалять реагенты")
    
    if request.method == 'POST':
        reagent_name = reagent.name
        reagent.delete()
        messages.success(request, f'Реагент "{reagent_name}" удален')
        return HttpResponseRedirect(reverse('object_list'))
    
    context = {
        'object': reagent,
    }
    
    return render(request, 'object_confirm_delete.html', context)
```

### URL для удаления
```28:28:intranet/urls.py
path('objects/<int:pk>/delete/', views.object_delete, name='object_delete'),
```

**Пример:** `/objects/5/delete/`

---

## 7. Добавление объекта

### View для создания
```238:267:intranet/views.py
@login_required
def object_create(request):
    """
    Создание нового реагента
    
    Демонстрирует:
    - ModelForm
    - is_valid()
    - cleaned_data
    - обработка request.FILES
    """
    # Проверка прав
    if request.user.role not in ['lab_head', 'sysadmin']:
        raise Http404("У вас нет прав для создания реагентов")
    
    if request.method == 'POST':
        form = ReagentForm(request.POST, request.FILES)
        if form.is_valid():
            reagent = form.save()
            messages.success(request, f'Реагент "{reagent.name}" успешно создан')
            return HttpResponseRedirect(reagent.get_absolute_url())
    else:
        form = ReagentForm()
    
    context = {
        'form': form,
        'title': 'Создать реагент',
    }
    
    return render(request, 'forms/object_form.html', context)
```

### URL для создания
```26:26:intranet/urls.py
path('objects/create/', views.object_create, name='object_create'),
```

**Пример:** `/objects/create/`

### Форма ReagentForm
```79:162:intranet/forms.py
class ReagentForm(forms.ModelForm):
    """
    Форма для создания/редактирования реагента
    """
    
    class Meta:
        model = Reagent
        fields = [
            'name', 'category', 'on_hand', 'min_threshold',
            'expiry_date', 'image', 'certificate', 'external_link'
        ]
        widgets = {
            'name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'Название реагента'
            }),
            'category': forms.Select(attrs={'class': 'form-select'}),
            'on_hand': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01'
            }),
            'min_threshold': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01'
            }),
            'expiry_date': forms.DateInput(attrs={
                'class': 'form-control',
                'type': 'date'
            }),
            'image': forms.FileInput(attrs={'class': 'form-control'}),
            'certificate': forms.FileInput(attrs={'class': 'form-control'}),
            'external_link': forms.URLInput(attrs={
                'class': 'form-control',
                'placeholder': 'https://example.com'
            }),
        }
```

---

## 8. Демонстрация CRUD

### Список объектов (Read all)
```159:198:intranet/views.py
@login_required
def object_list(request):
    """
    Список реагентов с фильтрацией
    """
    reagents_list = Reagent.objects.all()
    
    # Фильтрация
    category = request.GET.get('category')
    if category:
        reagents_list = reagents_list.filter(category=category)
    
    # Фильтр критических реагентов
    if request.GET.get('critical') == 'true':
        reagents_list = reagents_list.filter(on_hand__lt=F('min_threshold'))
    
    # Сортировка
    sort_by = request.GET.get('sort', 'name')
    reagents_list = reagents_list.order_by(sort_by)
    
    # Пагинация
    paginator = Paginator(reagents_list, 15)
    page = request.GET.get('page')
    reagents = paginator.get_page(page)
    
    # Категории для фильтра
    categories = Reagent.CATEGORY_CHOICES
    
    context = {
        'reagents': reagents,
        'categories': categories,
        'selected_category': category,
    }
    
    return render(request, 'object_list.html', context)
```

### Шаблон со списком и кнопками
```django
{# object_list.html #}
{% for reagent in reagents %}
<div class="card mb-3">
    <div class="card-body">
        <h5 class="card-title">
            <a href="{% url 'reagent_detail' pk=reagent.pk %}">
                {{ reagent.name }}
            </a>
        </h5>
        <p>Остаток: {{ reagent.on_hand }}</p>
        
        {% if can_edit %}
            <a href="{% url 'object_update' pk=reagent.pk %}" 
               class="btn btn-primary btn-sm">
                Редактировать
            </a>
        {% endif %}
        
        {% if can_delete %}
            <a href="{% url 'object_delete' pk=reagent.pk %}" 
               class="btn btn-danger btn-sm">
                Удалить
            </a>
        {% endif %}
    </div>
</div>
{% endfor %}
```

---

## 9. Права доступа

### Модель User с ролями
```17:51:intranet/models.py
class User(AbstractUser):
    """
    Кастомная модель пользователя с ролями
    """
    ROLE_CHOICES = [
        ('employee', 'Сотрудник'),
        ('lab_head', 'Заведующий лабораторией'),
        ('sysadmin', 'Системный администратор'),
    ]
    
    role = models.CharField(
        'Роль',
        max_length=20,
        choices=ROLE_CHOICES,
        default='employee'
    )
```

### Проверка прав в view

**Просмотр:** Все авторизованные пользователи
```201:202:intranet/views.py
@login_required
def object_detail(request, pk):
```

**Создание:** lab_head и sysadmin
```250:251:intranet/views.py
if request.user.role not in ['lab_head', 'sysadmin']:
    raise Http404("У вас нет прав для создания реагентов")
```

**Редактирование:** lab_head и sysadmin
```282:284:intranet/views.py
if request.user.role not in ['lab_head', 'sysadmin']:
    messages.error(request, 'У вас нет прав для редактирования реагентов')
    return redirect('reagent_detail', pk=pk)
```

**Удаление:** только sysadmin
```316:317:intranet/views.py
if request.user.role != 'sysadmin':
    raise Http404("Только системный администратор может удалять реагенты")
```

### Передача прав в контекст
```223:225:intranet/views.py
user_role = request.user.role
can_edit = user_role in ['lab_head', 'sysadmin']
can_delete = user_role == 'sysadmin'
```

### Условное отображение кнопок
```django
{% if can_edit %}
    <a href="{% url 'object_update' pk=object.pk %}" class="btn btn-primary">
        Редактировать
    </a>
{% endif %}

{% if can_delete %}
    <a href="{% url 'object_delete' pk=object.pk %}" class="btn btn-danger">
        Удалить
    </a>
{% endif %}
```

---

## 10. Наполнение БД

### Скрипт создания тестовых данных
```
Файл: create_test_data.py
```

**Запуск:**
```bash
python create_test_data.py
```

### Минимум 10 объектов в каждой таблице
- Reagent - минимум 10 реагентов
- ReagentMovement - движения для каждого реагента
- User - несколько пользователей с разными ролями
- Recipe - рецептуры с использованием реагентов

---

## 11. User-friendly дизайн

### Bootstrap классы в формах
```92:95:intranet/forms.py
'name': forms.TextInput(attrs={
    'class': 'form-control',
    'placeholder': 'Название реагента'
}),
```

### Сообщения для пользователя
```9:9:intranet/views.py
from django.contrib import messages
```

```257:257:intranet/views.py
messages.success(request, f'Реагент "{reagent.name}" успешно создан')
```

```290:290:intranet/views.py
messages.success(request, f'Реагент "{updated_reagent.name}" обновлен')
```

```322:322:intranet/views.py
messages.success(request, f'Реагент "{reagent_name}" удален')
```

### Redirect после действий
```258:258:intranet/views.py
return HttpResponseRedirect(reagent.get_absolute_url())
```

```323:323:intranet/views.py
return HttpResponseRedirect(reverse('object_list'))
```

---

## Итоговая таблица CRUD

| Операция | URL | View | Права | Файл:Строки |
|----------|-----|------|-------|-------------|
| **Create** | `/objects/create/` | object_create | lab_head, sysadmin | views.py:238-267 |
| **Read (list)** | `/objects/` | object_list | Все авторизованные | views.py:159-198 |
| **Read (detail)** | `/objects/<pk>/` | object_detail | Все авторизованные | views.py:201-235 |
| **Update** | `/objects/<pk>/edit/` | object_update | lab_head, sysadmin | views.py:270-301 |
| **Delete** | `/objects/<pk>/delete/` | object_delete | sysadmin | views.py:304-329 |

---

## Сводка по правам доступа

| Роль | Просмотр | Создание | Редактирование | Удаление |
|------|----------|----------|----------------|----------|
| **employee** | ✅ | ❌ | ❌ | ❌ |
| **lab_head** | ✅ | ✅ | ✅ | ❌ |
| **sysadmin** | ✅ | ✅ | ✅ | ✅ |

---

## Контрольные вопросы

1. **Какой объект выбран?** - Reagent (реагент) с связанными ReagentMovement
2. **Как передается ID в URL?** - `path('objects/<int:pk>/', ...)`
3. **Какие права на создание?** - lab_head и sysadmin
4. **Кто может удалять?** - Только sysadmin
5. **Сколько связанных таблиц?** - 3 (ReagentMovement, Recipe, User)
6. **Что происходит после создания?** - Redirect на детальную страницу + сообщение
7. **Что если нет прав на редактирование?** - Сообщение об ошибке + redirect
8. **Как проверяются права?** - По полю user.role
9. **Где список всех объектов?** - `/objects/` (object_list)
10. **Есть ли фильтрация в списке?** - Да, по категории и критичности

